<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>å›¾åƒå¤„ç†åº”ç”¨</title>
		<link rel="stylesheet" href="/static/style.css" />
		<link
			href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap"
			rel="stylesheet"
		/>
	</head>
	<body>
		<div class="container">
			<header class="app-header">
				<div class="header-top">
					<h1>ğŸ¨ æ™ºèƒ½å›¾åƒå¤„ç†</h1>
					<div class="user-info">
						<span>æ¬¢è¿, {{ user_email }}</span>
						<a href="/logout" class="logout-button">ç™»å‡º</a>
					</div>
				</div>
				<p>ä¸Šä¼ æ‚¨çš„å›¾ç‰‡ï¼Œå³åˆ»ä½“éªŒç°åº¦è½¬æ¢</p>
			</header>

			<section class="upload-section card">
				<h2>ä¸Šä¼ å›¾ç‰‡</h2>
				<form id="uploadForm" enctype="multipart/form-data" class="upload-form">
					<label for="imageInput" class="custom-file-upload">
						<span id="fileNameDisplay">é€‰æ‹©å›¾ç‰‡æ–‡ä»¶...</span>
						<input
							type="file"
							name="file"
							id="imageInput"
							accept="image/*"
							required
						/>
					</label>
					<button type="submit" class="submit-button">ä¸Šä¼ å¹¶å¤„ç†</button>
				</form>
				<div id="loadingIndicator" class="loading-indicator">
					<div class="spinner"></div>
					<p>å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...</p>
				</div>
				<p id="errorMessage" class="error-message"></p>
			</section>

			<section class="video-section card">
				<h2>å®æ—¶æ‘„åƒå¤´è§†é¢‘</h2>
				<div class="video-wrapper">
					<img
						id="videoFeed"
						src="/video_feed"
						alt="Camera Feed"
						onerror="this.onerror=null;this.src='/static/video_placeholder.png';"
					/>
				</div>
				<p>æ­¤è§†é¢‘æµæ˜¾ç¤ºå®æ—¶æ‘„åƒå¤´ç”»é¢åŠäººè„¸æ£€æµ‹ã€‚</p>
			</section>

			<section class="results-section" id="resultsSection"></section>

			<footer class="app-footer">
				<p>&copy; 2025 æ™ºèƒ½å›¾åƒå¤„ç†åº”ç”¨. ç‰ˆæƒæ‰€æœ‰.</p>
			</footer>
		</div>

		<script>
			const uploadForm = document.getElementById("uploadForm");
			const imageInput = document.getElementById("imageInput");
			const fileNameDisplay = document.getElementById("fileNameDisplay");
			const loadingIndicator = document.getElementById("loadingIndicator");
			const errorMessage = document.getElementById("errorMessage");
			const resultsSection = document.getElementById("resultsSection");

			// æ£€æŸ¥ JWT æ˜¯å¦æœ‰æ•ˆ
			async function checkAuthAndRedirect() {
				try {
					const response = await fetch("/check_auth"); // åç«¯éœ€è¦æä¾›ä¸€ä¸ªç®€å•çš„è®¤è¯æ£€æŸ¥è·¯ç”±
					if (response.status === 401) {
						// JWT æ— æ•ˆï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µ
						window.location.href = `/login?redirect_to=${encodeURIComponent(
							window.location.pathname + window.location.search
						)}`;
					}
					// å¦‚æœå“åº”æ˜¯ 200 OKï¼Œåˆ™è¯´æ˜è®¤è¯æˆåŠŸï¼Œç»§ç»­åŠ è½½é¡µé¢
				} catch (error) {
					console.error("è®¤è¯æ£€æŸ¥å¤±è´¥:", error);
					// å¯ä»¥åœ¨è¿™é‡Œé€‰æ‹©æ˜¯å¦é‡å®šå‘ï¼Œæˆ–è€…æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
				}
			}

			// æ¨èåœ¨é¡µé¢åŠ è½½æ—¶è°ƒç”¨è®¤è¯æ£€æŸ¥
			// window.onload = checkAuthAndRedirect; // å¦‚æœæ‚¨åœ¨ main.py ä¸­å·²ç»é€šè¿‡ Depends(get_current_user_jwt) ä¿æŠ¤äº† /index è·¯ç”±ï¼Œåˆ™ä¸éœ€è¦æ­¤ JS ä¾§çš„æ£€æŸ¥

			imageInput.addEventListener("change", () => {
				if (imageInput.files.length > 0) {
					fileNameDisplay.textContent = imageInput.files[0].name;
				} else {
					fileNameDisplay.textContent = "é€‰æ‹©å›¾ç‰‡æ–‡ä»¶...";
				}
			});

			uploadForm.addEventListener("submit", async (event) => {
				event.preventDefault(); // é˜»æ­¢è¡¨å•é»˜è®¤æäº¤è¡Œä¸º

				errorMessage.textContent = ""; // æ¸…é™¤ä¹‹å‰çš„é”™è¯¯ä¿¡æ¯
				resultsSection.innerHTML = ""; // æ¸…é™¤ä¹‹å‰çš„å›¾ç‰‡ç»“æœ
				resultsSection.style.display = "none"; // éšè—ç»“æœåŒºåŸŸ
				loadingIndicator.style.display = "flex"; // æ˜¾ç¤ºåŠ è½½æŒ‡ç¤ºå™¨

				const formData = new FormData();
				const file = imageInput.files[0];
				if (!file) {
					errorMessage.textContent = "è¯·é€‰æ‹©ä¸€ä¸ªå›¾ç‰‡æ–‡ä»¶ï¼";
					loadingIndicator.style.display = "none";
					return;
				}
				formData.append("file", file);

				try {
					const response = await fetch("/upload_image", {
						method: "POST",
						body: formData,
					});

					if (response.status === 401) {
						// æœªè®¤è¯ï¼Œé‡å®šå‘åˆ°ç™»å½•é¡µ
						window.location.href = `/login?redirect_to=${encodeURIComponent(
							window.location.pathname + window.location.search
						)}`;
						return;
					}

					if (!response.ok) {
						const errorData = await response.json();
						throw new Error(errorData.detail || "å›¾ç‰‡å¤„ç†å¤±è´¥ã€‚");
					}

					const data = await response.json();

					// åˆ›å»ºåŸå§‹å›¾ç‰‡å¡ç‰‡
					const originalImageCard = document.createElement("div");
					originalImageCard.className = "image-card";
					originalImageCard.innerHTML = `
                        <h3>åŸå§‹å›¾ç‰‡</h3>
                        <div class="image-wrapper">
                            <img src="${
															data.original_image_url
														}" alt="Original Image" onload="this.style.opacity=1;">
                        </div>
                        <p>æ–‡ä»¶å¤§å°: ${formatBytes(file.size)}</p>
                    `;

					const processedImageCard = document.createElement("div");
					processedImageCard.className = "image-card";
					processedImageCard.innerHTML = `
                        <h3>ç°åº¦å¤„ç†å›¾ç‰‡</h3>
                        <div class="image-wrapper">
                            <img src="${data.processed_image_url}" alt="Grayscale Image" onload="this.style.opacity=1;">
                        </div>
                        <p>å¤„ç†å®Œæˆ</p>
                    `;

					// å°†å›¾ç‰‡å¡ç‰‡æ·»åŠ åˆ°ç»“æœåŒºåŸŸ
					resultsSection.appendChild(originalImageCard);
					resultsSection.appendChild(processedImageCard);
					resultsSection.style.display = "flex"; // æ˜¾ç¤ºç»“æœåŒºåŸŸ
				} catch (error) {
					console.error("ä¸Šä¼ æˆ–å¤„ç†å›¾ç‰‡æ—¶å‡ºé”™:", error);
					errorMessage.textContent = "å›¾ç‰‡å¤„ç†å¤±è´¥: " + error.message;
				} finally {
					loadingIndicator.style.display = "none"; // éšè—åŠ è½½æŒ‡ç¤ºå™¨
				}
			});

			// è¾…åŠ©å‡½æ•°ï¼šæ ¼å¼åŒ–æ–‡ä»¶å¤§å°
			function formatBytes(bytes, decimals = 2) {
				if (bytes === 0) return "0 Bytes";
				const k = 1024;
				const dm = decimals < 0 ? 0 : decimals;
				const sizes = ["Bytes", "KB", "MB", "GB", "TB"];
				const i = Math.floor(Math.log(bytes) / Math.log(k));
				return (
					parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + " " + sizes[i]
				);
			}
		</script>
	</body>
</html>
